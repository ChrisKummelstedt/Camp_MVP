<div class="page-container">
  <div class="page-wrapper">
    <div class="panel panel-default">
      <div class="panel-body">
        <div class="jumbotron" id="index-jumbo">
          <div class="row">
            <div class="col-md-4">
              <div class="img-circle">
                <%= image_tag @project.image.url(:circle), :class => "profile-image img-responsive img-circle " %>
              </div>
            </div>
            <div class="col-md-8">
              <% if @cfo %>
              <h3><%= link_to "<span class='glyphicon glyphicon-edit floatright'></span>".html_safe, edit_project_path(@project) %></h3>
              <h3><span class="floatright"> &nbsp|&nbsp</span><%= link_to "<span class='glyphicon glyphicon-piggy-bank floatright'></span>".html_safe, project_receipts_path(@project) %></h3>
              <% end %>
              <h3><%= @project.title %></h3>
            </div>
          </div>
        </div>
      </div>
    </div>
    <ul class="nav nav-tabs">
      <li class="active"><a href="#dashboard">Dashboard</a></li>
      <li><a href="#teams">Teams</a></li>
      <li><a href="#budgetoverview">Financial Overview</a></li>
      <li><a href="#budgetdetail">Budget & Receipts</a></li>
      <li><a href="#progress">Progress</a></li>
    </ul>
    <div class="tab-content">
      <div id="dashboard" class="tab-pane fade in active">
        <div class="panel panel-default">
          <div class="panel-body">
            <div class="panel panel-default">
              <div class="panel-body">

                <div class="row">
                  <div class="col-md-9">
                    <h3>Dashboard</h3>
                    <p><%= @project.description %></p>
                    <% unless @project.inventories == [] %>
                    <p><b>Resources for the project can be found in:</b></p>
                    <% @project.inventories.each do |inventory| %>
                    <P><%= link_to "<span class='glyphicon glyphicon-th-large'></span>".html_safe + " " + inventory.name, inventory_path(inventory) %></p>
                      <% end %>
                      <% end %>
                    </div>
                    <div class="col-md-3">
                      <div class="panel panel-default">
                        <div class="panel-body">
                          <h4><span class="glyphicon glyphicon-heart"></span> <%= @project.teams.size %> teams</h4>
                          <h4><span class="glyphicon glyphicon-user"></span> <%= @usercount %> people</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <% unless @project.focus.nil? %>
              <div class="panel panel-default">
                <div class="panel-body">
                  <h3>Key things on the agenda</h3>
                  <h4><span class="glyphicon glyphicon-chevron-right"></span> <%= @project.focus %></h4>
                </div>
              </div>
              <% end %>

              <% unless @completed_todo.size == 0 || @not_completed_todo.size == 0 %>
              <div class="panel panel-default">
                <div class="panel-body">
                  <div class="row">
                    <div class="col-md-9">
                      <h3>Completed and pending action points</h3>
                      <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="<%= @progress %>" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: <%= @progress %>%;">
                          <%= @progress %>%
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="panel panel-default">
                        <div class="panel-body">
                          <h4><span class="glyphicon glyphicon-check"></span> <%= @completed_todo.size %></h4>
                          <h4><span class="glyphicon glyphicon-unchecked"></span> <%= @not_completed_todo.size %></h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>




              <% end %>
              <div class="panel panel-default">
                <div class="panel-body">
                  <center>
                    <%= image_tag "http://maps.googleapis.com/maps/api/staticmap?center=#{@project.latitude},#{@project.longitude}&markers=#{@project.latitude},#{@project.longitude}&zoom=15&size=640x400&key=AIzaSyCZ4K0_zcXxMjm6RwvYCczETWkr0CELFy4",
                    class: 'img-fluid img-rounded', alt: "#{@project.title} on the map"%>
                  </center>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div id="teams" class="tab-pane fade">
          <div class="panel panel-default">
            <div class="panel-body">
              <h3>Teams</h3>
              <p><b>Team overview</b></p>
              <div class="panel panel-default">
                <div class="panel-body">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Team size/Optimal size</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @project.teams.sort.each do |team| %>
                      <tr>
                        <td> <%= link_to team.title, project_team_path(@project, team) %> </td>
                        <td> <%= team.users.all.size %> <% if team.size %> (<%= team.size %>) <% end %> </td>
                        <td> <%= team.description %> </td>
                        <td> <%= link_to "<span class='glyphicon glyphicon-chevron-right'></span>".html_safe, project_team_path(@project, team) %></td>
                      </tr>
                      <% end %>
                    </tbody>
                  </table>
                  <% if current_user%>
                  <%= link_to "Add team <span class='glyphicon glyphicon-plus-sign'></span>".html_safe, new_project_team_path(@project),  id: "Create a Team" %>
                  <% end %>
                </div>
              </div>

              <p><b>Skills in the project</b></p>
              <div class="panel panel-default">
                <div class="panel-body">
                  <% skillarray = [] %>
                  <% @project.teams.each do |team| %>
                  <% team.users.each do |member| %>
                  <% member.skills.each do |talent| %>
                  <% skillarray << talent.skill.strip %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <%= skillarray.uniq.join(", ") %>
                </div>
              </div>

              <p><b>Team members</b></p>
              <div class="panel panel-default">
                <div class="panel-body">
                  <table class="table table-striped">
                    <tbody>

                      <% @project.teams.each do |team| %>
                      <% teamarray = [] %>
                      <tr>
                        <td> <%= team.title %></td>
                        <td>
                          <% team.users.each do |team_member| %>
                          <% teamarray << team_member.user_name %>
                          <% end %>
                          <%= teamarray.uniq.join(", ") %>
                        </td>
                      </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div id="budgetoverview" class="tab-pane fade">
          <div class="panel panel-default">
            <div class="panel-body">
              <h3>Budget</h3>
              <p><b>Planned budget compared to current budget</b></p>
              <p><%= @project.title %> is configured to display a suggested budget of <%= @project.total_budget %>. This value is compared below to give us a chance to see how the sum of all team budgets compare to the total budget anticipated for the project.</p>
            </br>
          </br>
          <div class="panel panel-default">
            <div class="panel-body">
              <div id="barchart" style="min-width: 620px; height: 400px; max-width: 620px; margin: 0 auto"></div>
            </br>
          </div>
        </div>
        <p>The suggested total budget for <%= @project.title %> is <%= @project.total_budget %>. The sum of budget items from all teams is currently <%=@project.teams.sum(:team_budget) %>. This means that we are currently at <b><%= (((@project.teams.sum(:team_budget))/(@project.total_budget)) * 100).round(1) %>% </b> of the suggested total.</p>
        <p><b>Budget breakdown by team</b></p>
        <p><%= @project.title %> has <%= @project.teams.size %> teams. The total for all teams amount to <%= @project.total_budget %>.
        </br>
      </br>
      <div class="panel panel-default">
        <div class="panel-body">
          <div id="piechart" style="min-width: 620px; height: 400px; max-width: 620px; margin: 0 auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="budgetdetail" class="tab-pane fade">
  <div class="panel panel-default">
    <div class="panel-body">
      <div class="col-md-7">
        <h3>Budget details and receipts</h3>
      </div>
      <div class="col-md-5">
        <div class="panel panel-default">
          <div class="panel-body">
            <h4><span class="glyphicon glyphicon-chevron-up"></span> Income: <%= @project.revenue %></h4>
            <h4><span class="glyphicon glyphicon-chevron-down"></span> Expenditure: <%= @receiptstotal %></h4>
            <h4><span class="glyphicon glyphicon-piggy-bank"></span> Budget: <%= @project.teams.sum(:team_budget) %></h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="panel panel-default">
    <div class="panel-body">
      <h2> Budget Items </h2>
      <% @project.teams.each do |team| %>
      <div class="panel panel-default">
        <div class="panel-body">
          <table class="table table-hover table-budget">
            <h3 class="clearboth"><%= link_to team.title, project_team_path(@project, team) %></h3>
            <thead>
              <th>Item</th>
              <th>Quantity</th>
              <th>Cost Per Item</th>
              <th>Total</th>
            </thead>
            <tbody>
              <% teamtotal = 0 %>
              <% team.budgets.each do |item| %>
              <tr>
                <td class="colA"><%=item.budget_item.capitalize %></td>
                <td class="colB"><%=item.quantity %></td>
                <td class="colC"><%=item.cost_per_item %></td>
                <td class="colD"><%=itemtotal = ((item.quantity * item.cost_per_item).round(2))%></td>
              </tr>
              <% teamtotal += itemtotal %>
              <% end %>
            </tbody>
          </table>
          <h4 class="floatright">Sum: <%= teamtotal.round(2) %>&nbsp</h4>
        </div>
      </div>

      <% end %>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-body">
      <h3>Receipts</h3>
      <% if @receipts.size > 0 %>

      <table class="table table-hover">
        <thead>
          <tr>
            <th>Item</th>
            <th>Date</th>
            <th>Amount</th>
            <th>User</th>
            <th>Paid out?</th>
          </tr>
        </thead>
        <tbody>
          <% @receipts.each do |r| %>
          <% team = Team.find(r.team) %>
          <% owner = User.find(r.binder.user).user_name %>
          <tr>
            <td><%= r.name %></td>
            <td><%= r.date %></td>
            <td><%= r.amount %></td>
            <td><%= link_to owner, profile_path(owner) %></td>
            <td><%= r.paid? ? "Paid #{r.paiddate.strftime("%F")}" : "No" %></td>
          </tr>
          <% end %>
        </tbody>
      </table>
      <h4 class="floatright">Total: <%= @receiptstotal %></h4>


      <% else %>
      <p>No receipts assigned to project.</p>
      <% end %>
    </div>
  </div>
</div>

<div id="progress" class="tab-pane fade">
  <% unless @completed_todo.size == 0 || @not_completed_todo.size == 0 %>
  <div class="panel panel-default">
    <div class="panel-body">
      <div class="panel panel-default">
        <div class="panel-body">
          <div class="col-md-9">
            <h3>Completed and pending action points</h3>
            <div class="progress">
              <div class="progress-bar" role="progressbar" aria-valuenow="<%= @progress %>" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: <%= @progress %>%;">
                <%= @progress %>%
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="panel panel-default">
              <div class="panel-body">
                <h4><span class="glyphicon glyphicon-check"></span> <%= @completed_todo.size %></h4>
                <h4><span class="glyphicon glyphicon-unchecked"></span> <%= @not_completed_todo.size %></h4>
              </div>
            </div>
          </div>
        </div>
      </div>
      <h3>What is left to do?</h3>
      <table class="table table-hover">
        <tbody>
          <% @not_completed_todo.each do |todo| %>
          <tr><td><%= link_to Team.find(todo.team_id).title, project_team_path(@project, Team.find(todo.team_id)) %> - <%=todo.description%> <% unless todo.user_id == nil %><i> - <%= link_to User.find(todo.user_id).user_name, profile_path(User.find(todo.user_id).user_name) %></i><% end %></td>
            <% end %>
          </td></tr>
        </tbody>
      </table>
      <h3>Already done</h3>
      <table class="table table-hover">
        <tbody>
          <% @completed_todo.each do |todo| %>
          <tr><td><%= link_to Team.find(todo.team_id).title, project_team_path(@project, Team.find(todo.team_id)) %> - <%=todo.description%> <% unless todo.user_id == nil %><i> - <%= link_to User.find(todo.user_id).user_name, profile_path(User.find(todo.user_id).user_name) %></i><% end %></td>
            <% end %>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<% else %>
<div class="panel panel-default">
  <div class="panel-body">
    <h3>This page is all ready to serve up a juicy overview</h3>
    <p>To populate the page, start creating teams and adding to do list items to the project.</p>
  </div>
</div>
<% end %>
</div>
</div>


<script>
$(function () {
  $('#piechart').highcharts({
    chart: {
      plotBackgroundColor: null,
      plotBorderWidth: null,
      plotShadow: false,
      type: 'pie'
    },
    title: {
      text: 'Breakdown'
    },
    tooltip: {
      pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },
    plotOptions: {
      pie: {
        allowPointSelect: true,
        cursor: 'pointer',
        dataLabels: {
          enabled: true,
          format: '<b>{point.name}</b>: {point.percentage:.1f} %',
          style: {
            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
          }
        }
      }
    },
    series: [{
      name: "Team name",
      colorByPoint: true,
      data: [   <% @project.teams.each do |team| %> {
        name: "<%=team.title%>",
        y:<%=team.team_budget.to_i%>
      }, <%end%>
    ]
  }]
});
});
$(function () {
  $('#barchart').highcharts({
    chart: {
      type: 'column'
    },
    title: {
      text: 'Total'
    },
    xAxis: {
      categories: ['Team budgets', 'Suggested project budget']
    },
    yAxis: {
      min: 0,
      title: {
        text: 'Estimated budgets'
      },
      stackLabels: {
        enabled: true,
        style: {
          fontWeight: 'bold',
          color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
        }
      }
    },
    tooltip: {
      headerFormat: '<b>{point.x}</b><br/>',
      pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
    },
    plotOptions: {
      column: {
        stacking: 'normal',
        dataLabels: {
          enabled: true,
          color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
          style: {
            textShadow: '0 0 3px black'
          }
        }
      }
    },
    series: [ <% @project.teams.each do |team| %> {
      name: "<%=team.title%>",
      data: [<%=team.team_budget.to_i%>,0]
    }, <%end%> {
      name: "<%=@project.title%>",
      data: [0, <%= @project.total_budget %>]
    }
  ]
});
});
</script>

<script>
$(document).on('ready page:load', function () {
  $("tspan:contains('0')").hide();
});
</script>


<script>
$(document).on('ready page:load', function () {
  $(".nav-tabs a").click(function(){
    $(this).tab('show');
  });
});
</script>
